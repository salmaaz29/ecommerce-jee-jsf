<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
<h:head>
    <title>Gestion des Produits</title>
    <style>
        .ui-panelgrid .ui-panelgrid-cell {
            padding: 5px;
        }
        .ui-panelgrid .ui-panelgrid-content {
            overflow: visible;
        }
    </style>
</h:head>
<h:body>
    <h:form id="adminProduitForm">
        <p:panel id="adminPanel" header="Gestion des Produits" style="width: 100%; max-width: 800px; margin: 0 auto;"
                 rendered="#{userBean.isAdmin()}">
            <!-- Messages pour les erreurs ou succès -->
            <p:messages id="messages" showDetail="true" showSummary="false" autoUpdate="true"/>

            <!-- Formulaire pour ajouter/modifier un produit -->
            <p:panelGrid id="editPanel" columns="2" style="width: 100%; margin-bottom: 20px;">
                <h:outputLabel for="nom" value="Nom du produit *"/>
                <p:inputText id="nom"
                             value="#{produitBean.selectedProduit.nom}"
                             required="true"
                             requiredMessage="Le nom est requis"
                             style="width: 100%;">
                    <p:ajax event="blur" update="messages"/>
                </p:inputText>

                <h:outputLabel for="prix" value="Prix (DH) *"/>
                <p:inputNumber id="prix"
                               value="#{produitBean.selectedProduit.prix}"
                               required="true"
                               min="0"
                               minFractionDigits="2"
                               maxFractionDigits="2"
                               decimalSeparator="."
                               thousandSeparator=""
                               requiredMessage="Le prix est requis"
                               style="width: 100%;">
                    <p:ajax event="blur" update="messages"/>
                </p:inputNumber>

                <h:outputLabel for="image" value="URL de l'image *"/>
                <p:inputText id="image"
                             value="#{produitBean.selectedProduit.image}"
                             required="true"
                             requiredMessage="L'URL de l'image est requise"
                             style="width: 100%;">
                    <p:ajax event="blur" update="messages"/>
                </p:inputText>

                <h:outputLabel for="stock" value="Stock *"/>
                <p:inputNumber id="stock"
                               value="#{produitBean.selectedProduit.stock}"
                               required="true"
                               min="0"
                               decimalPlaces="0"
                               requiredMessage="Le stock est requis"
                               style="width: 100%;">
                    <p:ajax event="blur" update="messages"/>
                </p:inputNumber>

                <h:outputLabel for="description" value="Description"/>
                <p:inputTextarea id="description"
                                 value="#{produitBean.selectedProduit.description}"
                                 rows="3"
                                 style="width: 100%;"/>
            </p:panelGrid>

            <div style="text-align: center; margin-bottom: 20px;">
                <p:commandButton value="#{produitBean.selectedProduit.id_produit == null ? 'Ajouter' : 'Modifier'}"
                                 action="#{produitBean.saveProduit}"
                                 update="adminPanel messages"
                                 process="@form"
                                 icon="pi pi-check"
                                 styleClass="ui-button-success"
                                 style="margin-right: 10px;"/>
                <p:commandButton value="Annuler"
                                 action="#{produitBean.resetSelectedProduit}"
                                 update="editPanel"
                                 process="@this"
                                 icon="pi pi-times"
                                 styleClass="ui-button-secondary"/>
            </div>

            <!-- Liste des produits -->
            <p:dataTable id="produitTable"
                         value="#{produitBean.produits}"
                         var="produit"
                         style="width: 100%;"
                         paginator="true"
                         rows="10"
                         paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                         rowsPerPageTemplate="5,10,15">

                <p:column headerText="ID" style="width: 50px; text-align: center;">
                    <h:outputText value="#{produit.id_produit}"/>
                </p:column>

                <p:column headerText="Nom" sortBy="#{produit.nom}" filterBy="#{produit.nom}">
                    <h:outputText value="#{produit.nom}"/>
                </p:column>

                <p:column headerText="Prix" style="text-align: right;">
                    <h:outputText value="#{produit.prix}">
                        <f:convertNumber type="number" minFractionDigits="2" maxFractionDigits="2"/>
                    </h:outputText> DH
                </p:column>

                <p:column headerText="Stock" style="width: 80px; text-align: center;">
                    <h:outputText value="#{produit.stock}"
                                  style="color: #{produit.stock > 0 ? 'green' : 'red'}; font-weight: bold;"/>
                </p:column>

                <p:column headerText="Image" style="width: 200px;">
                    <p:graphicImage value="#{produit.image}"
                                    height="50"
                                    rendered="#{not empty produit.image}"/>
                    <h:outputText value="Aucune image"
                                  rendered="#{empty produit.image}"
                                  style="font-style: italic; color: #999;"/>
                </p:column>

                <p:column headerText="Actions" style="width: 150px; text-align: center;">
                    <p:commandButton value="Modifier"
                                     action="#{produitBean.editProduit(produit)}"
                                     update=":adminProduitForm:editPanel :adminProduitForm:messages"
                                     process="@this"
                                     icon="pi pi-pencil"
                                     styleClass="ui-button-warning"
                                     style="margin-right: 5px;"/>
                    <p:commandButton value="Supprimer"
                                     action="#{produitBean.deleteProduit(produit)}"
                                     update=":adminProduitForm:produitTable :adminProduitForm:messages"
                                     process="@this"
                                     icon="pi pi-trash"
                                     styleClass="ui-button-danger">
                        <p:confirm header="Confirmation"
                                   message="Voulez-vous vraiment supprimer #{produit.nom} ?"
                                   icon="pi pi-exclamation-triangle"/>
                    </p:commandButton>
                </p:column>
            </p:dataTable>

            <div style="text-align: center; margin-top: 20px;">
                <p:button value="Retour au tableau de bord"
                          outcome="dashboard_admin.xhtml"
                          icon="pi pi-home"/>
            </div>
        </p:panel>

        <p:panel header="Accès interdit" rendered="#{!userBean.isAdmin()}">
            <h:outputText value="Vous n'avez pas les droits pour accéder à cette page."/>
            <p:button value="Retour" outcome="produits.xhtml"/>
        </p:panel>

        <!-- Dialog de confirmation -->
        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade">
            <p:commandButton value="Oui" type="button"
                             styleClass="ui-confirmdialog-yes"
                             icon="pi pi-check"/>
            <p:commandButton value="Non" type="button"
                             styleClass="ui-confirmdialog-no"
                             icon="pi pi-times"/>
        </p:confirmDialog>
    </h:form>
</h:body>
</html>