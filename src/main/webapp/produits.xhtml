<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui">
<h:head>
    <title>Catalogue Produits</title>
</h:head>
<h:body>
    <h:form id="mainForm">
        <p:panel header="Catalogue des Produits" rendered="#{userBean.logged}">
            <p:dataTable value="#{produitBean.produits}" var="produit">
                <p:column headerText="Nom">
                    <h:outputText value="#{produit.nom}"/>
                </p:column>
                <p:column headerText="Prix">
                    <h:outputText value="#{produit.prix}"/>
                </p:column>
                <p:column headerText="Action">
                    <p:commandButton value="Ajouter au panier"
                                     action="#{panierBean.addToCart(produit)}"
                                     update=":mainForm:panierPanel"
                                     process="@this"
                                     ajax="true" />
                </p:column>
            </p:dataTable>

            <p:panel id="panierPanel" header="Panier" style="margin-top: 20px">
                <p:dataTable value="#{panierBean.lignes}" var="ligne">
                    <p:column headerText="Produit">
                        <h:outputText value="#{ligne.produit.nom}"/>
                    </p:column>
                    <p:column headerText="Quantité">
                        <p:spinner value="#{ligne.quantite}"
                                   min="1"
                                   onSpinUpdate="updateQuantity(#{ligne}, #{ligne.quantite})"/>
                        <p:commandButton value="Update"
                                         action="#{panierBean.updateQuantity(ligne, ligne.quantite)}"
                                         update=":mainForm:panierPanel"
                                         style="display:none;"
                                         id="updateBtn#{ligne.produit.id_produit}"/>
                    </p:column>
                    <p:column headerText="Total">
                        <h:outputText value="#{ligne.produit.prix * ligne.quantite}">
                            <h:column type="currency" currencySymbol="DH"/>
                        </h:outputText>
                    </p:column>
                    <p:column headerText="Action">
                        <p:commandButton value="Supprimer"
                                         action="#{panierBean.remove(ligne)}"
                                         update=":mainForm:panierPanel"/>
                    </p:column>
                </p:dataTable>
                <h:outputText value="Total : #{panierBean.total} DH" style="font-weight: bold"/>
                <p:commandButton value="Valider Commande"
                                 action="#{commandeBean.validerCommande()}"
                                 update=":mainForm:panierPanel"
                                 rendered="#{not empty panierBean.lignes}"/>
            </p:panel>
            <p:commandButton value="Déconnexion"
                             action="#{userBean.logout()}"
                             immediate="true"
                             ajax="false"/>
        </p:panel>
        <p:panel header="Accès requis" rendered="#{!userBean.logged}">
            <h:outputText value="Veuillez vous connecter pour voir les produits."/>
            <p:button value="Se connecter" outcome="login.xhtml"/>
        </p:panel>
    </h:form>

    <script type="text/javascript">
        function updateQuantity(ligne, quantite) {
            // Cette fonction peut être utilisée pour mettre à jour la quantité via AJAX
            // Vous pouvez implémenter une mise à jour automatique si nécessaire
        }
    </script>
</h:body>
</html>